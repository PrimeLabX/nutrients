<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N栄養計画ツール</title>
    <link rel="stylesheet" href="style.css" />
  </head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NX586SE5W2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NX586SE5W2');
</script>
  
  <body>
  <div class="wrapper">
    <main>
    <!-- タブ -->
    <div class="tab-container">
      <button class="tab-button active" data-target="formulas">栄養製剤</button>
      <button class="tab-button" data-target="needs">必要栄養量</button>
      <button class="tab-button" data-target="hai">オリジナル</button>
    </div>

    <!-- 必要栄養量タブ -->
    <div id="needs" class="tab-content">
      <h2>患者の必要栄養量</h2>
      <div>
        <label>体重 (kg): <input type="number" id="weightInput" min="0" /></label>
      </div>
      <div>
        <label>
          カロリー係数 (kcal/kg/day):
          <input
            type="range"
            id="kcalFactorInput"
            min="10"
            max="40"
            value="25"
            step="1"
          />
          <span id="kcalFactorDisplay">25</span> kcal/kg
        </label>
      </div>
      <div>
        <label>
          病態（タンパク係数）:
          <select id="conditionSelect">
            <option data-min="" data-max="">-- 選択してください --</option>
            <option data-min="1.0" data-max="1.5" selected>異化亢進（1.0～1.5 g/kg）</option>
            <option data-min="0.8" data-max="1.0">正常（0.8～1.0 g/kg）</option>
            <option data-min="0.8" data-max="1.0">急性腎不全（0.8～1.0 g/kg）</option>
            <option data-min="0.6" data-max="0.8">保存期 CKD（0.6～0.8 g/kg）</option>
            <option data-min="1.2" data-max="1.4">血液透析（1.2～1.4 g/kg）</option>
            <option data-min="1.3" data-max="1.5">腹膜透析（1.3～1.5 g/kg）</option>
            <option data-min="1.2" data-max="1.2">肝疾患・肝硬変（1.2 g/kg）</option>
            <option data-min="0.5" data-max="0.5">肝性脳症（0.5 g/kg）</option>
          </select>
        </label>
      </div>
       <!-- 肥満チェックボタン -->
<!-- 肥満チェックボタン -->
<div>
  <button id="checkObesity">BMIチェック</button>
</div>

<!-- 身長入力欄（初期非表示）-->
<div id="heightInputArea" style="display: none;">
  <label>身長 (cm): <input type="number" id="heightInput" min="0" /></label>
</div>

      <div id="needsResult"></div>
    </div>


    <!-- 栄養製剤タブ -->
    <div id="formulas" class="tab-content active">
      <h2>栄養製剤の投与量</h2>
      <div id="formulaContainer">
        <div class="formula-group">
          <p><strong>製剤1</strong></p>
          <div class="quick-buttons" id="quick1"></div>
          <select class="formula-select" data-index="0"></select>
          <div class="input-container" id="inputContainer0"></div>
        </div>
        <div class="formula-group">
          <p><strong>製剤2</strong></p>
          <div class="quick-buttons" id="quick2"></div>
          <select class="formula-select" data-index="1"></select>
          <div class="input-container" id="inputContainer1"></div>
        </div>
        <div class="formula-group">
          <p><strong>製剤3</strong></p>
          <div class="quick-buttons" id="quick3"></div>
          <select class="formula-select" data-index="2"></select>
          <div class="input-container" id="inputContainer2"></div>
        </div>
        <div class="formula-group">
          <p><strong>製剤4</strong></p>
          <div class="quick-buttons" id="quick4"></div>
          <select class="formula-select" data-index="3"></select>
          <div class="input-container" id="inputContainer3"></div>
        </div>
        
      </div>
      <div id="infusionResult"></div>
    </div>
    
    <!-- HAIタブ -->
  <div id="hai" class="tab-content">
    <h2>オリジナル製剤設計(HighcalicRF,Amiparen,Intralipid)</h2>
    <p>必要エネルギー: <span id="default-calorie"></span>kcal, タンパク: <span id="default-protein"></span>g (必要栄養量タブから結果引き継ぎ)</p>
    
    <label>総カロリー (kcal):
      <input id="input-calorie" type="number" step="1">
    </label>
    <label>タンパク質 (g):
      <input id="input-protein" type="number" step="0.1">
    </label>
    <label>脂質 (g):
      <input id="input-fat" type="number" step="0.1">
    </label><br>
    <br>
    <!-- プロポフォールONボタン -->
    <button id="toggle-propofol">プロポフォール ON</button>

    <!-- プロポフォール速度入力欄（初期非表示） -->
    <div id="propofol-input-area" style="display: none; margin-top: 8px;">
      <label>プロポフォール速度 (mL/h):
        <input id="propofol-rate" type="number" step="0.1">
      </label>
    </div>

    <p>必要アミパレン量: <span id="amiparen-ml">-</span> mL</p>
    <p>必要ハイカリックRF量: <span id="haikalyk-ml">-</span> mL</p>
    <p>エレジェクト、ダイメジンマルチ、KCLを必要に応じて追加</p>
  </div>
    
    </main>
    
  <footer class="site-footer">
  <div class="footer-content">
    <p>&copy; 2025 栄養計画ツール. All rights reserved.　
    <a href="./howto.html" class="footer-link">使用法</a>
    </p>
    
  </div>
  </footer>
  
   </div>
  <script>
  
//関数格納
function roundToOneDecimals(num) {
  return Math.round(num * 10) / 10;
}


var  protein_max = 0;
var protein_min = 0;
var calorieNeeds = 0;

document.addEventListener("DOMContentLoaded", function () {

　//HAIプロポボタン
  const toggleButton = document.getElementById("toggle-propofol");
  const propofolInputArea = document.getElementById("propofol-input-area");
  
  toggleButton.addEventListener("click", function () {
    const isVisible = propofolInputArea.style.display === "block";
    propofolInputArea.style.display = isVisible ? "none" : "block";
    toggleButton.textContent = isVisible ? "プロポフォール ON" : "プロポフォール OFF";
    calculateHAI(); // ← 追加！
  });
  
  // タブ切り替え
  const tabButtons = document.querySelectorAll(".tab-button");
  const tabContents = document.querySelectorAll(".tab-content");
  tabButtons.forEach((btn) => {
      
    btn.addEventListener("click", function () {
  const target = this.dataset.target;

  tabButtons.forEach((b) => b.classList.remove("active"));
  tabContents.forEach((c) => c.classList.remove("active"));

  this.classList.add("active");
  document.getElementById(target).classList.add("active");

  if (target === "hai") {
    initHAI();
  }
});
  });
  
  
//必要栄養量計算タブ
  const weightInput = document.getElementById("weightInput");
  const kcalFactorInput = document.getElementById("kcalFactorInput");
  const conditionSelect = document.getElementById("conditionSelect");
  weightInput.addEventListener("input", calculateNeeds);
  kcalFactorInput.addEventListener("input", () => {
    document.getElementById("kcalFactorDisplay").textContent = kcalFactorInput.value;
    calculateNeeds();
  });
  conditionSelect.addEventListener("change", calculateNeeds);

let obesityCheckOn = false; // 初期状態はOFF

document.getElementById("checkObesity").addEventListener("click", function () {
  obesityCheckOn = !obesityCheckOn;
  const heightArea = document.getElementById("heightInputArea");
  const button = document.getElementById("checkObesity");

  if (obesityCheckOn) {
    heightArea.style.display = "block";
  } else {
    heightArea.style.display = "none";
  }

  calculateNeeds(); // 状態変更時に再計算
});
document.getElementById("heightInput").addEventListener("input", function () {
  if (obesityCheckOn) {
    calculateNeeds();
  }
});
  

function calculateNeeds() {
  const weight = parseFloat(weightInput.value);
  const height = parseFloat(document.getElementById("heightInput").value);
  const kcalFactor = parseFloat(kcalFactorInput.value);
  const selectedOption = conditionSelect.options[conditionSelect.selectedIndex];

  const proteinMin = parseFloat(selectedOption.dataset.min);
  const proteinMax = parseFloat(selectedOption.dataset.max);

  if (isNaN(weight) || weight <= 0 || isNaN(proteinMin) || isNaN(proteinMax)) {
    document.getElementById("needsResult").innerHTML = "<p>体重と病態を正しく入力してください。</p>";
    return;
  }

  let baseWeight = weight;
  let bmi = null;
  let usedAdjustedWeight = false;

  if (obesityCheckOn && !isNaN(height) && height > 0) {
    const heightM = height / 100;
    bmi = weight / (heightM * heightM);

    if (bmi >= 30) {
      const idealWeight = 22 * (heightM * heightM);
      const adjustedWeight = idealWeight + 0.225 * (weight - idealWeight);
      baseWeight = adjustedWeight;
      usedAdjustedWeight = true;
    }
  }

  const totalKcal = baseWeight * kcalFactor;
  const totalProteinMin = baseWeight * proteinMin;
  const totalProteinMax = baseWeight * proteinMax;

  let proteinDisplay = "";
  if (proteinMin === proteinMax) {
    proteinDisplay = `${totalProteinMin.toFixed(1)} g/day`;
    protein_max = totalProteinMax
    protein_min  = totalProteinMin;
  } else {
    proteinDisplay = `${totalProteinMin.toFixed(1)} ～ ${totalProteinMax.toFixed(1)} g/day`;
    protein_max = totalProteinMax
    protein_min  = totalProteinMin;
  }

  let note = "";
  if (obesityCheckOn && bmi !== null) {
    if (usedAdjustedWeight) {
      note = `<p><strong>BMI:</strong> ${bmi.toFixed(1)}（BMI>=30のため調整体重${baseWeight.toFixed(1)}kgで栄養計算(調整体重＝理想体重＋(0.225(実体重- 理想体重))))</p>`;
    } else {
      note = `<p><strong>BMI:</strong> ${bmi.toFixed(1)}（BMI<30のため実体重で栄養計算）</p>`;
    }
  }
  
  calorieNeeds = totalKcal
  
  
  // 平均タンパク量（初期値として使用）
  var proteinAvg = ((protein_min + protein_max) / 2).toFixed(1);
  document.getElementById("input-calorie").value = calorieNeeds.toFixed(0);
  document.getElementById("input-protein").value = proteinAvg;
  document.getElementById("input-fat").value = 0;
  

  document.getElementById("needsResult").innerHTML = `
    <hr>
    ${note}
    <p><strong>必要カロリー:</strong> ${Math.round(totalKcal)} kcal/day</p>
    <p><strong>必要タンパク量:</strong> ${proteinDisplay}</p>
  `;
}


//栄養製剤計算
// 製剤定義
const formulas = {
  peptamenAF: { name: "ペプタメンAF", kcalPerMl: 1.5, proteinPerMl: 0.095,fatPerMl:0.066, type: "rate", naPerMl: 2.63, kPerMl: 2.32 , naEqPerMl: 0, kEqPerMl: 0
      },
  terumeal2_0a: { name: "テルミール2.0α", kcalPerMl: 2.0,fatPerMl:0.075,proteinPerMl: 0.0725, type: "rate", naPerMl: 1, kPerMl: 1, naEqPerMl: 0, kEqPerMl: 0
      },
  recoverymini: { name: "リカバリーmini", kcalPerMl: 1.6,fatPerMl:0.06,proteinPerMl: 0.064, type: "rate", naPerMl: 230/125, kPerMl: 180/125, naEqPerMl: 0, kEqPerMl: 0
      },
  hinexre: { name: "ハイネックスリニュート", kcalPerMl: 1,fatPerMl: 22.4/400, proteinPerMl: 24/400, type: "rate", naPerMl: 1.59, kPerMl: 1, naEqPerMl: 0, kEqPerMl: 0
      },
  renalmp: {name: "リーナレンMP", kcalPerMl: 200 / 125, proteinPerMl: 7.0 / 125, fatPerMl: 5.6 / 125,type: "rate",naPerMl: 120/125, kPerMl: 60 / 125,naEqPerMl:0,  kEqPerMl:0
      },
  CZ_Hi: { name: "CZ_Hi", kcalPerMl: 1.0,fatPerMl:0.022,proteinPerMl: 0.05, type: "rate", naPerMl: 0.9, kPerMl: 1.5, naEqPerMl: 0, kEqPerMl: 0
      },
  mainbalance: { name: "メイン", kcalPerMl: 1,fatPerMl:0.028,proteinPerMl: 0.05, type: "rate", naPerMl: 0.7, kPerMl: 0.8, naEqPerMl: 0, kEqPerMl: 0
      },
  ELENTAL: { name: "エレンタール80g/300mL", kcalPerMl: 300/300, fatPerMl:0.51/300, proteinPerMl: 14.1/300, type: "rate", naPerMl: 260/300, kPerMl: 217.6/300, naEqPerMl: 0, kEqPerMl: 0
      },
  marmedone: { name: "マーメッドワン", kcalPerMl: 300/300, fatPerMl:11.4/300, proteinPerMl: 12/300, type: "rate", naPerMl: 420/300, kPerMl: 495/300, naEqPerMl:0, kEqPerMl: 0
      },
  renawell: { name: "レナウェル3", kcalPerMl: 200/125,fatPerMl:8.9/125,proteinPerMl: 3/125, type: "rate", naPerMl: 60/125, kPerMl: 20/125, naEqPerMl: 0, kEqPerMl: 0
      },
  elneopaNF1: { name: "エルネオパNF1", kcalPerMl: 0.56,fatPerMl:0, proteinPerMl: 0.02, type: "rate", naPerMl: 0, kPerMl: 0, naEqPerMl: 0.05, kEqPerMl: 0.022
      },
  elneopaNF2: { name: "エルネオパNF2", kcalPerMl: 0.82,fatPerMl:0, proteinPerMl: 0.03, type: "rate", naPerMl: 0, kPerMl: 0, naEqPerMl: 0.05, kEqPerMl: 0.027
      },
  kidoparen: { name: "キドパレン", kcalPerMl: 1500/1050, fatPerMl:0, proteinPerMl: 32.847/1050, type: "rate", naPerMl: 0, kPerMl: 0 , naEqPerMl: 50/1050, kEqPerMl: 0, memo: "微量元素が入ってない"
      },
  hullcalic: { name: "フルカリック3", kcalPerMl: 1160/1103, fatPerMl:0, proteinPerMl: 40/1103, type: "rate", naPerMl: 0, kPerMl: 0, naEqPerMl:50/1103, kEqPerMl: 30/1103
      },
　highcalic: { name: "ハイカリックRF", kcalPerMl: 2,fatPerMl:0, proteinPerMl: 0, type: "rate", naPerMl: 0, kPerMl: 0, naEqPerMl: 25/500, kEqPerMl: 0
      }, 
  highcalicamiparen: { name: "HA", kcalPerMl: 580/450,fatPerMl:0, proteinPerMl: 20/450, type: "rate", naPerMl: 0, kPerMl: 0, naEqPerMl: 12.9/450, kEqPerMl: 0, memo:"ハイカリックRF250,アミパレン200"
      }, 
  highcalic2amiparen: { name: "H2A", kcalPerMl: 660/650,fatPerMl:0, proteinPerMl: 40/650, type: "rate", naPerMl: 0, kPerMl: 0, naEqPerMl: 13.3/650, kEqPerMl: 0, memo:"ハイカリックRF250,アミパレン400"
      }, 
  highcalic3amiparen: { name: "H3A", kcalPerMl: 740/850,fatPerMl:0, proteinPerMl: 60/850, type: "rate", naPerMl: 0, kPerMl: 0, naEqPerMl: 13.7/850, kEqPerMl: 0, memo:"ハイカリックRF250,アミパレン600"
      }, 
　bfluid: { name: "ビーフリード", kcalPerUnit: 210, fatPerUnit:0, proteinPerUnit: 15, type: "count", waterPerUnit: 500, naPerUnit: 0, kPerUnit: 0, naEqPerUnit: 17.5, kEqPerUnit: 10,memo: "同一パックで８時間以上の持続点滴や他剤混注は菌血症リスクのため非推奨"
      },
　amiparen200: { name: "アミパレン200", kcalPerUnit: 80,fatPerUnit:0, proteinPerUnit: 20, waterPerUnit: 200, type: "count", naPerUnit: 0, kPerUnit: 0, naEqPerUnit: 0.4,　kEqPerUnit: 0
      },
　kidmine: { name: "キドミン200", kcalPerUnit: 14.41*4, fatPerUnit:0, proteinPerUnit: 14.41,　waterPerUnit: 200, type: "count", naPerMl: 0, kPerMl: 0, naEqPerUnit:0.4, kEqPerUnit: 0
      },
　aminoleban: { name: "アミノレバン500", kcalPerUnit: 39.93*4, fatPerUnit:0, proteinPerUnit: 39.93, type: "count", naPerUnit: 0, kPerMl: 0, naEqPerMl:7, kEqPerMl:0, waterPerUnit: 500
      },
  Intralipid: { name: "イントラリポス20%100mL", kcalPerUnit: 200, fatPerUnit:200/9, proteinPerUnit: 0, type: "count", naPerMl: 0, kPerUnit: 0, naEqPerUnit: 0, kEqPerUnit: 0, waterPerUnit:100,
      },
  soldem1: { name: "ソルデム1", kcalPerMl: 52/500,fatPerMl:0, proteinPerMl: 0, type: "rate", naPerMl: 0, kPerMl: 0, naEqPerMl: 45/500, kEqPerMl: 0
      },
  soldem3: { name: "ソルデム3", kcalPerMl: 0.108,fatPerMl:0, proteinPerMl: 0, type: "rate", naPerMl: 0, kPerMl: 0, naEqPerMl: 0.05, kEqPerMl: 0.02
      },
  soldem3A: { name: "ソルデム3A", kcalPerMl: 0.172, fatPerMl:0,proteinPerMl: 0, type: "rate", naPerMl: 0, kPerMl: 0, naEqPerMl: 0.035, kEqPerMl: 0.02
      },
  soldem3AG: { name: "ソルデム3AG", kcalPerMl: 0.3, fatPerMl:0,proteinPerMl: 0, type: "rate", naPerMl: 0, kPerMl: 0, naEqPerMl: 0.035, kEqPerMl: 0.02
      },
　solacetf: { name: "ソルアセトF", kcalPerMl: 0,fatPerMl:0, proteinPerMl: 0, type: "rate", naPerMl: 0, kPerMl: 0, naEqPerMl: 0.131, kEqPerMl: 0.004
      },
　normalsaline: { name: "生理食塩水", kcalPerMl: 0, fatPerMl:0, proteinPerMl: 0, type: "rate", naPerMl: 0, kPerMl: 0, naEqPerMl: 0.154, kEqPerMl: 0.154
      },
　D5W: { name: "5%ブドウ糖液", kcalPerMl: 50/250, fatPerMl:0, proteinPerMl: 0, type: "rate", naPerMl: 0, kPerMl: 0, naEqPerMl: 0, kEqPerMl: 0
      },
  D10W: { name: "10%ブドウ糖液", kcalPerMl: 200/500, fatPerMl:0, proteinPerMl: 0, type: "rate", naPerMl: 0, kPerMl: 0, naEqPerMl: 0, kEqPerMl: 0
      },
  meylon: { name: "メイロン8.4%10mL", kcalPerUnit: 0,fatPerUnit:0, proteinPerUnit: 0, waterPerUnit:10, type: "count", naPerUnit: 0, kPerUnit: 5, naEqPerUnit: 0,　kEqPerUnit: 0
      }, 
　agarori: { name: "アガロリーゼリー", kcalPerUnit: 150,fatPerUnit:0, proteinPerUnit: 0, waterPerUnit: 83, type: "count", naPerUnit: 0, kPerUnit: 0, naEqPerUnit: 0.4,　kEqPerUnit: 0
      },
  propofol: { name: "プロポフォール", kcalPerMl: 1.1, proteinPerMl: 0,fatPerMl:1.1/9, type: "rate", naPerMl: 0, kPerMl: 0 , naEqPerMl: 0, kEqPerMl: 0
      },
}

const quickList = ["peptamenAF",　"recoverymini", "hinexre",　"renalmp",  "renawell",  "propofol"];

for (let i = 0; i < 4; i++) {
  const quickArea = document.getElementById(`quick${i + 1}`);
  const select = document.querySelector(`select[data-index='${i}']`);
  const inputContainer = document.getElementById(`inputContainer${i}`);

  // クイックボタン生成
  quickList.forEach((key) => {
    const btn = document.createElement("button");
    btn.className = "formula-btn";
    btn.textContent = formulas[key].name;
    btn.addEventListener("click", () => {
      select.value = key;
      select.dispatchEvent(new Event("change"));
    });
    quickArea.appendChild(btn);
  });

const sectionTitles = {
  0: "-経管栄養-",
  10: "-カロリー輸液-",
  19: "-タンパク質-",
  22: "-脂質-",
  23: "-その他-",
};

// セレクトメニュー生成
const defaultOption = document.createElement("option");
defaultOption.value = "";
defaultOption.textContent = `-- 製剤${i + 1}を選択 --`;
select.appendChild(defaultOption);

let index = 0;
for (const [key, formula] of Object.entries(formulas)) {
  if (sectionTitles.hasOwnProperty(index)) {
    const section = document.createElement("option");
    section.disabled = true;
    section.textContent = sectionTitles[index];
    select.appendChild(section);
  }

  const option = document.createElement("option");
  option.value = key;
  option.textContent = formula.name;
  select.appendChild(option);

  index++;
}

  // セレクト変更時の処理
  // 以下は製剤選択時のイベントリスナー内の全体コード（OFFボタンを含む）
document.querySelectorAll(".formula-select").forEach((select) => {
  select.addEventListener("change", () => {
    const index = parseInt(select.dataset.index, 10);
    const selected = select.value;
    const inputContainer = document.getElementById(`inputContainer${index}`);
    inputContainer.innerHTML = "";

    if (!selected || !formulas[selected]) return;

    if (formulas[selected].type === "rate") {
      const container = document.createElement("div");
      container.style.display = "flex";
      container.style.alignItems = "center";
      container.style.gap = "8px";

      const label = document.createElement("label");
      label.textContent = "速度 (mL/h): ";

      const input = document.createElement("input");
      input.type = "number";
      input.min = "0";
      input.step = "1";
      input.className = "rate";
      input.addEventListener("input", calculateInfusion);

      label.appendChild(input);
      container.appendChild(label);

      const presetContainer = document.createElement("div");
      presetContainer.className = "preset-container";
     

      [10, 20, 30, 40, 50, 60, 70].forEach((val) => {
        const btn = document.createElement("button");
        btn.textContent = val;
        btn.type = "button";
        btn.className = "preset-btn";
        btn.addEventListener("click", () => {
          input.value = val;
          input.dispatchEvent(new Event("input"));
        });
        presetContainer.appendChild(btn);
      });

      const offBtn = document.createElement("button");
      offBtn.textContent = "OFF";
      offBtn.type = "button";
      offBtn.className = "preset-btn";
      offBtn.addEventListener("click", () => {
        select.value = "";
        inputContainer.innerHTML = "";
        calculateInfusion();
      });
      presetContainer.appendChild(offBtn);

      container.appendChild(presetContainer);
      inputContainer.appendChild(container);
    } else if (formulas[selected].type === "count") {
      const container = document.createElement("div");
      container.style.display = "flex";
      container.style.alignItems = "center";
      container.style.gap = "8px";

      const label = document.createElement("label");
      label.textContent = "個数: ";

      const input = document.createElement("input");
      input.type = "number";
      input.min = "0";
      input.step = "0.1";
      input.className = "count";
      input.addEventListener("input", calculateInfusion);

      label.appendChild(input);
      container.appendChild(label);

      const presetContainer = document.createElement("div");
      presetContainer.className = "preset-container";

      [1, 2, 3, 4].forEach((val) => {
        const btn = document.createElement("button");
        btn.textContent = val;
        btn.type = "button";
        btn.className = "preset-btn";
        btn.addEventListener("click", () => {
          input.value = val;
          input.dispatchEvent(new Event("input"));
        });
        presetContainer.appendChild(btn);
      });

      const offBtn = document.createElement("button");
      offBtn.textContent = "OFF";
      offBtn.type = "button";
      offBtn.className = "preset-btn";
      offBtn.addEventListener("click", () => {
        select.value = "";
        inputContainer.innerHTML = "";
        calculateInfusion();
      });
      presetContainer.appendChild(offBtn);

      container.appendChild(presetContainer);
      inputContainer.appendChild(container);
    }

    calculateInfusion();
  });
});
}

  
  // 比較ボタンを作成してbodyに追加
const compareBtn = document.createElement("button");
compareBtn.textContent = "製剤比較(120mLあたり)";
compareBtn.className = "compare-btn";
compareBtn.style.marginTop = "20px";
compareBtn.addEventListener("click", () => {
  for (let i = 0; i < 4; i++) {
    const select = document.querySelector(`select[data-index='${i}']`);
    const selected = select.value;
    if (!formulas[selected]) continue;

    if (formulas[selected].type === "rate") {
      const input = document.querySelector(`#inputContainer${i} .rate`);
      if (input) {
        input.value = 5;
        input.dispatchEvent(new Event("input")); // 再計算させる
      }
    }
  }
});

const target = document.getElementById("inputContainer3"); // 製剤4のinputContainer
if (target && target.parentNode) {
  target.parentNode.insertBefore(compareBtn, target.nextSibling);
} else {
  document.body.appendChild(compareBtn); // フォールバック
}

function calculateInfusion() {
  let totalKcal = 0;
  let totalProtein = 0;
  let totalfat = 0;
  let totalWater = 0;
  let totalNa = 0;
  let totalK = 0;
  let totalNaEq = 0;
  let totalKEq = 0;
  let resultHTML = "";

  // 重複なく製剤名＋メモを保持するMap（キー: 製剤名, 値: memo）
  const memoMap = new Map();

  const selects = document.querySelectorAll(".formula-select");
  selects.forEach((select, i) => {
    const key = select.value;
    if (!key || !formulas[key]) return;
    const formula = formulas[key];
    const inputDiv = document.getElementById(`inputContainer${i}`);

    if (formula.type === "rate") {
      const rateInput = inputDiv.querySelector(".rate");
      const rate = parseFloat(rateInput?.value);
      if (isNaN(rate) || rate <= 0) return;
      const volume = rate * 24;
      const kcal = volume * formula.kcalPerMl;
      const protein = volume * formula.proteinPerMl;
      const fat = volume * formula.fatPerMl;
      const water = volume;
      const na = formula.naPerMl ? volume * formula.naPerMl : 0;
      const k = formula.kPerMl ? volume * formula.kPerMl : 0;
      const naEq = formula.naEqPerMl ? volume * formula.naEqPerMl : 0;
      const kEq = formula.kEqPerMl ? volume * formula.kEqPerMl : 0;

      totalKcal += kcal;
      totalProtein += protein;
      totalfat += fat;
      totalWater += water;
      totalNa += na;
      totalK += k;
      totalNaEq += naEq;
      totalKEq += kEq;

      resultHTML += `<p><strong>${formula.name}</strong>：${volume} mL → ${Math.round(kcal)} kcal, タンパク質${Math.round(protein)}g, 脂質${Math.round(fat)}g, Na: ${Math.round(na)}mg, K:${Math.round(k)}mg, Na:${Math.round(naEq)}mEq, K:${Math.round(kEq)}mEq</p>`;

      if (formula.memo && !memoMap.has(formula.name)) {
        memoMap.set(formula.name, formula.memo);
      }
    } else if (formula.type === "count") {
      const countInput = inputDiv.querySelector(".count");
      const count = parseFloat(countInput?.value);
      if (isNaN(count) || count <= 0) return;
      const kcal = count * formula.kcalPerUnit;
      const protein = count * formula.proteinPerUnit;
      const fat = count * formula.fatPerUnit;
      const water = count * formula.waterPerUnit;
      const na = formula.naPerUnit ? count * formula.naPerUnit : 0;
      const k = formula.kPerUnit ? count * formula.kPerUnit : 0;
      const naEq = formula.naEqPerUnit ? count * formula.naEqPerUnit : 0;
      const kEq = formula.kEqPerUnit ? count * formula.kEqPerUnit : 0;

      totalKcal += kcal;
      totalProtein += protein;
      totalfat += fat;
      totalWater += water;
      totalNa += na;
      totalK += k;
      totalNaEq += naEq;
      totalKEq += kEq;

      resultHTML += `<p><strong>${formula.name}</strong>：${count} 個 → ${Math.round(kcal)} kcal, タンパク質${Math.round(protein)}g, 脂質${Math.round(fat)}g, Na:${Math.round(na)}mg, K:${Math.round(k)}mg, Na:${Math.round(naEq)}mEq, K:${Math.round(kEq)}mEq</p>`;

      if (formula.memo && !memoMap.has(formula.name)) {
        memoMap.set(formula.name, formula.memo);
      }
    }
  });

  // カロリー計算と割合は変わらず
  const proteinKcal = totalProtein * 4;
  const fatKcal = totalfat * 9;
  const proteinRatio = Math.round(isNaN(proteinKcal / totalKcal) ? 0 : (proteinKcal / totalKcal) * 100);
  const fatRatio = Math.round(isNaN(fatKcal / totalKcal) ? 0 : (fatKcal / totalKcal) * 100);
  const carbRatio =  totalWater > 0 ? (100-fatRatio-proteinRatio > 0 ? 100-fatRatio-proteinRatio : 0):0;

  resultHTML += `<hr><p><strong>合計:</strong> 水分${Math.round(totalWater)} mL</p>`;
  resultHTML += `<p>${Math.round(totalKcal)} kcal (炭水化物: ${carbRatio}% タンパク質: ${proteinRatio}% 脂質: ${fatRatio}%)　タンパク質 ${Math.round(totalProtein)} g, 脂質 ${Math.round(totalfat)} g</p>`;
  resultHTML += `<p>Na: ${Math.round(totalNa)} mg, K: ${Math.round(totalK)} mg, Na: ${Math.round(totalNaEq)} mEq, K: ${Math.round(totalKEq)} mEq　(経管栄養はmg, 輸液はmEqでそれぞれ合算)</p>`;

  // 重複なしメモ表示
  if (memoMap.size > 0) {
    memoMap.forEach((memo, name) => {
      resultHTML += `<p><strong>${name}:</strong> <span style="color:red">${memo}</span></p>`;
    });
    resultHTML += `</div>`;
  }

  document.getElementById("infusionResult").innerHTML = resultHTML || "<p>有効な入力がありません。</p>";
}

//hai

function initHAI() {
  const calorieEl = document.getElementById("default-calorie");
  const proteinEl = document.getElementById("default-protein");
  const infoParagraph = calorieEl.closest("p"); // <p> タグ全体を取得

  if (calorieNeeds > 0 && protein_min > 0) {
    // 表示更新
    calorieEl.textContent = calorieNeeds.toFixed(0);
    let proteinDisplay = protein_min === protein_max
      ? protein_min.toFixed(1)
      : `${protein_min.toFixed(1)}〜${protein_max.toFixed(1)}`;
    proteinEl.textContent = proteinDisplay;

    // <p>を表示
    infoParagraph.style.display = "block";
  } else {
    // <p>を非表示
    infoParagraph.style.display = "none";
  }

  calculateHAI(); // 初期計算
}


function calculateHAI() {
  var protein = parseFloat(document.getElementById("input-protein").value) || 0;
  var fat = parseFloat(document.getElementById("input-fat").value) || 0;
  var totalKcal = parseFloat(document.getElementById("input-calorie").value) || 0;

  var propofolRate = 0;
  if (document.getElementById("propofol-input-area").style.display !== "none") {
    propofolRate = parseFloat(document.getElementById("propofol-rate")?.value) || 0;
  }

  var propofolKcal = propofolRate * 24 * 1.1;
  var kcalFromProtein = protein * 4;
  var kcalFromFat = fat * 9;
  var kcalFromPF = kcalFromProtein + kcalFromFat + propofolKcal;

  var amiparenMl = protein * 10;
  var residualKcal = totalKcal - kcalFromPF;
  var haikalykMl = residualKcal > 0 ? residualKcal / 2 : 0;

  var pPct = totalKcal > 0 ? (kcalFromProtein / totalKcal) * 100 : 0;
  var fPct = totalKcal > 0 ? ((kcalFromFat + propofolKcal) / totalKcal) * 100 : 0;
  var cPct = totalKcal > 0 ? 100 - pPct - fPct : 0;

  document.getElementById("amiparen-ml").textContent = amiparenMl.toFixed(1);
  document.getElementById("haikalyk-ml").textContent = haikalykMl.toFixed(1);

  // --- カロリー構成の表示 ---
  let ratioEl = document.getElementById("nutrient-ratio");
  if (!ratioEl) {
    ratioEl = document.createElement("p");
    ratioEl.id = "nutrient-ratio";
    const reference = document.getElementById("haikalyk-ml").parentElement;
    reference.parentNode.insertBefore(ratioEl, reference.nextSibling);
  }
  ratioEl.innerHTML = `カロリー構成: 炭水化物 ${cPct.toFixed(0)}%、タンパク質 ${pPct.toFixed(0)}%、脂質 ${fPct.toFixed(0)}%`;

  // --- 総カロリーオーバー時のエラー表示 ---
  let errorEl = document.getElementById("calorie-over-error");
  if (!errorEl) {
    errorEl = document.createElement("p");
    errorEl.id = "calorie-over-error";
    errorEl.style.color = "red";
    const reference = ratioEl;
    reference.parentNode.insertBefore(errorEl, reference.nextSibling);
  }
  if (kcalFromPF > totalKcal) {
    errorEl.textContent = "⚠️ 必要タンパク,脂質量により総カロリーを超過しています。見直してください。";
  } else {
    errorEl.textContent = ""; // エラーがなければ非表示
  }
}
document.getElementById("input-protein").addEventListener("input", calculateHAI);
document.getElementById("input-fat").addEventListener("input", calculateHAI);
document.getElementById("input-calorie").addEventListener("input", calculateHAI);
document.getElementById("propofol-rate").addEventListener("input", calculateHAI);      

});
  </script>
</body>
</html>
